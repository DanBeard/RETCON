<!DOCTYPE html>
<html>
  <head>
    <title>RETCON</title>
    <meta charset="UTF-8" />

    <link rel="stylesheet" href="{{ url_for('static', filename='css/98.css') }}" />
    <style type="text/css">
        .large {
          font-size: 15px;
        }
        .xlarge {
          font-size:18px;
        }
        .tab-content {
          display: none;
        }
        .tab-content.active {
          display: block;
        }
        li[role="tab"] a {
          font-size: 20px;
        }
    </style>
  </head>

  <body style="background-color:#008080">
    <div class="window" style="margin-left: auto; margin-right:auto; width: 800px">
      <div class="title-bar">
        <div class="title-bar-text">
          RETCON!1!!One!1!  v0.0.9
        </div>

        <div class="title-bar-controls">
          <button aria-label="Minimize"></button>
          <button aria-label="Maximize"></button>
          <button aria-label="Close"></button>
        </div>
      </div>
      <div class="window-body">
        <img src="{{ url_for('static', filename='images/logo.png') }}" style="width:450px; margin-left:auto; margin-right:auto; display:block;" />
        <center><h3>{{admin.profile_name}}</h3></center>
        <p class="xlarge"> Please note that any user connected via Bluetooth will have access to this page and can make changes to your node!</p>


      <menu role="tablist">
        <li role="tab" id="tab-apps" ><a href="#apps" onclick="changeTab('apps')">Applications</a></li>
        <li role="tab" id="tab-bluetooth" ><a href="#bluetooth" onclick="changeTab('bluetooth')" >Bluetooth</a></li>
        <li role="tab" id="tab-files"><a href="#files" onclick="changeTab('files')">Files</a></li>
        <li role="tab" id="tab-advanced"><a href="#advanced" onclick="changeTab('advanced')">Advanced</a></li>
        <li role="tab" id="tab-credits"><a href="#credits" onclick="changeTab('credits')">Credits</a></li>
      </menu>

      <div class="window tab-content"  role="tabpanel" id="content-apps" >
        <div class="window-body">
          <h3> Mesh Status </h3>
          <div id="mesh-status" class="field-row" style="margin-bottom: 15px; padding: 10px; border: 1px solid #888;">
            <span id="mesh-state-indicator" style="display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; background-color: gray;"></span>
            <span class="large"><strong>State:</strong> <span id="mesh-state">Loading...</span></span>
            <span class="large" style="margin-left: 20px;"><strong>Peers:</strong> <span id="mesh-peers">-</span></span>
            <span class="large" style="margin-left: 20px;"><strong>IP:</strong> <span id="mesh-ip">-</span></span>
            <span class="large" style="margin-left: 20px;"><strong>Interface:</strong> <span id="mesh-iface">-</span></span>
            <button style="margin-left: 20px;" onclick="refreshMeshStatus()">Refresh</button>
          </div>

          <h3> Applications: </h3>
          <a class="xlarge" href="/" id='meshchatLink' >Reticulum MeshChat</a> <--- Use this to chat and browse
          <br />
          <br />
          <a class="xlarge" target="_blank" href="/static/rnode-flasher/index.html">Rnode Web Flasher</a> <--- Use this to flash Rnodes (requires chrome :( )
        </div>
      </div>

      <div class="window tab-content" role="tabpanel" id="content-bluetooth">
        <div class="window-body">
          <h3>Bluetooth Connection</h3>

          <div id="bt-status" class="field-row" style="margin-bottom: 15px; padding: 10px; border: 1px solid #888;">
            <span id="bt-state-indicator" style="display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; background-color: gray;"></span>
            <span class="large"><strong>Status:</strong> <span id="bt-state">Loading...</span></span>
            <span class="large" style="margin-left: 20px;"><strong>Name:</strong> <span id="bt-name">-</span></span>
            <span class="large" style="margin-left: 20px;"><strong>Connected:</strong> <span id="bt-connected">-</span></span>
            <button style="margin-left: 20px;" onclick="refreshBluetoothStatus()">Refresh</button>
          </div>

          <h4>How to Connect</h4>
          <p class="large">
            This RETCON node uses <strong>Bluetooth PAN</strong> (Personal Area Network) for connections.
          </p>
          <ol class="large">
            <li>Enable Bluetooth on your phone/tablet</li>
            <li>Scan for devices and look for "<span id="bt-name-instructions">RETCON-BT</span>"</li>
            <li>Pair with the device (one-time, no PIN required)</li>
            <li>Connect to the paired device</li>
            <li>Open browser and go to <strong>http://192.168.4.1</strong></li>
          </ol>

          <h4>Using Sideband App</h4>
          <p class="large">
            To connect the Sideband app via Bluetooth PAN, add this interface:
          </p>
          <pre style="background: #f0f0f0; padding: 10px; font-size: 14px;">
[[RETCON BT-PAN]]
  type = TCPClientInterface
  enabled = yes
  target_host = 192.168.4.1
  target_port = 4242</pre>

          <h4>Limitations</h4>
          <ul class="large">
            <li><strong>Range:</strong> ~10 meters (Bluetooth Class 2)</li>
            <li><strong>Max connections:</strong> 7 devices simultaneously</li>
            <li><strong>Throughput:</strong> ~2-3 Mbps (sufficient for messaging)</li>
          </ul>
        </div>
      </div>

      <div class="window tab-content" role="tabpanel" id="content-files">
        <div class="window-body">
          <iframe width="750px" height="600px" src="/file-explorer/browse" ></iframe>
        </div>
      </div>

      <div class="window tab-content" role="tabpanel" id="content-advanced">
        <div class="window-body">
          <div class="field-row-stacked" style="width: 760px">
            <label for="config_file">Config File</label>
            <textarea id="config_file" rows="25">{{admin.config_str}}</textarea>
            <button class="default" onclick="save_advanced()">Save</button>
          </div>
          <div class="field-row-stacked" style="width: 760px">
            <p> Commands </p>
            <button class="default" onclick="reboot()">Reboot Now</button>
            <button class="default" onclick="toggle_ssh()">Toggle SSH. (Currently Enabled={{ admin.ssh_enabled }})</button>
          </div>
          <div class="field-row-stacked" style="width: 760px">
            <p> Danger Zone </p>
            <button class="default" onclick="reset_reticulum_config()">Reset Reticulum Config (WARNING: THIS WILL ERASE EVERYTHING IN MESHCHAT)</button>
          </div>
        </div>
      </div>

      <div class="window tab-content" role="tabpanel"  id="content-credits">
        <div class="window-body">
        
         <p class="large">
          <br/> RETCON created By Varx (<a href='http://retcon.network'>http://retcon.network</a>)  
          <br/> Reticulum created by Mark Qvist (<a href='https://reticulum.network/credits.html'>https://reticulum.network/credits.html</a>) 
          <br/> Retiulum Meshchat created by Liam Cottle (<a href='https://github.com/liamcottle/reticulum-meshchat'>https://github.com/liamcottle/reticulum-meshchat</a>)
          <br/> RNS_Over_Meshtastic created by landandair(<a href='https://github.com/landandair/RNS_Over_Meshtastic.git'>https://github.com/landandair/RNS_Over_Meshtastic.git</a>)
          <br/> rpi-image-gen created by Raspberry Pi (<a href='https://github.com/raspberrypi/rpi-image-gen'>https://github.com/raspberrypi/rpi-image-gen</a>)
        </p>
        </div>
      </div>

      
      </div>
    </div>

    <script>
      let activeTab = "";

      function changeTab(tabName) {
        activeTab = tabName.replace('#','');
        const contents = document.querySelectorAll(".tab-content");
        for(let c of contents) {
          if(c.id=='content-'+activeTab) c.classList.add("active");
          else c.classList.remove("active")
        }

        const tabs = document.querySelectorAll("li[role='tab']");
        for(let t of tabs){
          if(t.id == "tab-"+activeTab) t.setAttribute("aria-selected","true");
          else t.removeAttribute("aria-selected");
        }
      }

      const defaultTab = window.location.hash || "apps"
      changeTab(defaultTab);

      // Bluetooth status function
      function refreshBluetoothStatus() {
        fetch("/api/bluetooth/status")
          .then(resp => resp.json())
          .then(data => {
            document.getElementById('bt-state').textContent = data.state || 'unknown';
            document.getElementById('bt-name').textContent = data.bt_name || 'N/A';
            document.getElementById('bt-connected').textContent = data.connected_devices || '0';

            // Update instructions with actual BT name
            if (data.bt_name) {
              document.getElementById('bt-name-instructions').textContent = data.bt_name;
            }

            // Update indicator color based on state
            const indicator = document.getElementById('bt-state-indicator');
            switch(data.state) {
              case 'running':
                indicator.style.backgroundColor = '#0f0';  // Green
                break;
              case 'degraded':
                indicator.style.backgroundColor = '#ff0';  // Yellow
                break;
              case 'failed':
              case 'error':
                indicator.style.backgroundColor = '#f00';  // Red
                break;
              default:
                indicator.style.backgroundColor = '#888';  // Gray
            }
          })
          .catch(err => {
            console.error('Failed to fetch Bluetooth status:', err);
            document.getElementById('bt-state').textContent = 'Error';
            document.getElementById('bt-state-indicator').style.backgroundColor = '#f00';
          });
      }

      // Fetch Bluetooth status on load
      refreshBluetoothStatus();

      function save_advanced() {
        //just PSK for now
        data = {
          config_file: document.getElementById('config_file').value || "not set"
        }

        fetch("/advanced", {method: "POST", body: JSON.stringify(data) })
        .then((resp)=> resp.json()
            .then((msg)=> {
              alert(msg.message);
              if(msg.status === "ok") window.location.reload();
            })
            )
      };

      function reboot() {
        fetch("/reboot",  {method: "POST", body: JSON.stringify({reboot:"reboot"}) })
        .then(resp=> resp.json()
            .then(msg=>{
              alert(msg.message);
              if(msg.status === "ok") window.location.reload();
            }))
      }

       function toggle_ssh() {
        fetch("/toggle_ssh",  {method: "POST", body: JSON.stringify({ssh:"toggle"}) })
        .then(resp=> resp.json()
            .then(msg=>{
              alert(msg.message);
              if(msg.status === "ok") window.location.reload();
            }))

            alert("attemping to toggle SSH. Please wait a few seconds.")
      }

      // adjust download sizing in iframe
      const iframe = document.querySelector("iframe");

      iframe.addEventListener("load", () => {
          const childDoc = iframe.contentDocument;
          const fileDiv = childDoc.querySelector(".file-explorer");
          fileDiv.style.width = "70vw";
      });

      function setMeshchatLink() {
        const portNum = (window.location.protocol == 'https:') ? 8443 : 8000
        document.getElementById('meshchatLink').href = window.location.protocol + "//" + window.location.hostname + ":" + portNum;
        //event.target.port=((location.protocol == 'https:') ? 8443 : 8000)
      }

      setMeshchatLink();

      // on load update our time based on the client
      function sync_time () {
        const epoch = Date.now()/1000;
        fetch("/set_time",  {method: "POST", body: JSON.stringify({epoch:epoch}) })
        .then(resp=> resp.json()
            .then(msg=>{
              if(msg.status === "ok") console.log(msg);
              else console.error(msg)
            }))
      }

      sync_time();

      // Mesh status functions
      function refreshMeshStatus() {
        fetch("/api/mesh/status")
          .then(resp => resp.json())
          .then(data => {
            document.getElementById('mesh-state').textContent = data.state || 'unknown';
            document.getElementById('mesh-peers').textContent = data.peer_count || '0';
            document.getElementById('mesh-ip').textContent = data.bat0_ip || 'N/A';
            document.getElementById('mesh-iface').textContent = data.interface || 'N/A';

            // Update indicator color based on state
            const indicator = document.getElementById('mesh-state-indicator');
            switch(data.state) {
              case 'running':
                indicator.style.backgroundColor = '#0f0';  // Green
                break;
              case 'degraded':
                indicator.style.backgroundColor = '#ff0';  // Yellow
                break;
              case 'failed':
              case 'error':
                indicator.style.backgroundColor = '#f00';  // Red
                break;
              default:
                indicator.style.backgroundColor = '#888';  // Gray
            }
          })
          .catch(err => {
            console.error('Failed to fetch mesh status:', err);
            document.getElementById('mesh-state').textContent = 'Error';
            document.getElementById('mesh-state-indicator').style.backgroundColor = '#f00';
          });
      }

      // Fetch mesh status on load and every 30 seconds
      refreshMeshStatus();
      setInterval(refreshMeshStatus, 30000);

      function reset_reticulum_config () {
        fetch("/reset_reticulum_config",  {method: "POST", body: JSON.stringify({do_reset:1}) })
        .then(resp=> resp.json()
            .then(msg=>{
              if(msg.status === "ok") console.log(msg);
              else console.error(msg)
            }))

            alert("Sent reset and reboot commands. Wait a few seconds then re-connect")
      }

    </script>
  </body>
</html>
